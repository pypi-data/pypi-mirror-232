name: Test & Publish PyPi release

on:
  workflow_dispatch: null
  release:
    types: [created]

jobs:
  test-pypi:
    name: Test PyPi release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip build

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

        # Ensure the last tag created is used
      - name: Set VERSION_TAG
        run: |
          response=$(curl --silent "https://api.github.com/repos/$GITHUB_REPOSITORY/releases")
          latest_date=""
          latest_release=""
          
          length=$(echo "$response" | jq '. | length')
          for (( i=0; i<length; i++ )); do
              current_date=$(echo "$response" | jq -r ".[$i].created_at")
              if [[ "$current_date" > "$latest_date" ]]; then
                  latest_date="$current_date"
                  latest_release=$(echo "$response" | jq -r ".[$i]")
              fi
          done
          VERSION_TAG=$(echo "$latest_release" | jq -r '.tag_name')
          echo "VERSION_TAG=$(echo $VERSION_TAG)" >> $GITHUB_ENV

      - name: Print VERSION_TAG
        run: |
          echo ${{ env.VERSION_TAG }}

      - name: Build source and binary
        run: python -m build --sdist --wheel .

      - name: Publish to test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: Sleep
        run: sleep 120

      - name: Test install from Test PyPI
        run: |
          pip install \
          --index-url https://test.pypi.org/simple/ \
          --extra-index-url https://pypi.org/simple \
          argo-jupyter-scheduler==${{ env.VERSION_TAG }}

  release-pypi:
    name: Publish Argo-Jupyter-Scheduler on PyPi
    runs-on: ubuntu-latest
    needs: test-pypi
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip build

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build source and binary
        run: python -m build --sdist --wheel .

      - name: Publish package
        uses: pypa/gh-action-pypi-publish@release/v1
