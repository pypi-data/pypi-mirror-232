#### coverage #################################################################
[tool.coverage.run]
branch = true
data_file = ".coverage/data"
parallel = true
omit = ["src/utilities/_numbagg/*.py", "src/utilities/clean_dir/__main__.py"]
plugins = ["coverage_conditional_plugin"]

[tool.coverage.report]
exclude_lines = ["# pragma: no cover", "@overload"]
fail_under = 100.0
skip_covered = true
skip_empty = true

[tool.coverage.html]
directory = ".coverage/html"

[tool.coverage.coverage_conditional_plugin.omit]
'not is_installed("cvxpy")' = "src/utilities/cvxpy.py"

[tool.coverage.coverage_conditional_plugin.rules]
os-ne-windows = 'sys_platform != "windows"'
os-ne-macos = 'sys_platform != "darwin"'
os-ne-linux = 'sys_platform != "linux"'
version-ge-311 = "sys_version_info >= (3, 11)"


#### hatch ####################################################################
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build]
sources = ["src"]

[tool.hatch.build.targets.wheel]
packages = ["src/utilities"]

[tool.hatch.version]
path = "src/utilities/__init__.py"


#### nitpick ##################################################################
[tool.nitpick]
style = [
  "https://raw.githubusercontent.com/dycw/nitpick/master/styles/common.toml",
  "https://raw.githubusercontent.com/dycw/nitpick/master/styles/3.9.toml",
  "https://raw.githubusercontent.com/dycw/nitpick/master/styles/pip-compile-no-hashes.toml",
]


#### project ##################################################################
[project]
name = "dycw-utilities"
dynamic = ["version"]
readme = "README.md"
requires-python = ">= 3.9"
authors = [{ name = "Derek Wan", email = "d.wan@icloud.com" }]
dependencies = ["typing-extensions >= 4.8.0"]

[project.optional-dependencies]
airium = ["airium >= 0.2.6"]
atomicwrites = ["atomicwrites >= 1.4.1"]
attrs = ["attrs >= 23.1.0"]
beartype = ["beartype >= 0.16.2"]
bidict = ["bidict >= 0.22.1"]
click = ["click >= 8.1.7"]
cryptography = ["cryptography >= 41.0.4"]
cvxpy = ["cvxpy >= 1.3.1; sys_platform == 'darwin'"]
fastapi = ["fastapi >= 0.103.0"]
fastparquet = [
  "fastparquet >= 2023.8.0",
  "atomicwrites >= 1.4.1",   # atomicwrites
]
fpdf2 = [
  "fpdf2 >= 2.7.5",
  "atomicwrites >= 1.4.1", # holoviews
  "holoviews >= 1.17.1",   # holoviews
  "selenium >= 4.12.0",    # holoviews
]
hatch = ["hatch >= 1.7.0"]
holoviews = [
  "holoviews >= 1.17.1",
  "selenium >= 4.12.0",
  "atomicwrites >= 1.4.1", # atomicwrites
]
hypothesis = ["hypothesis >= 6.87.0"]
loguru = ["loguru >= 0.7.2"]
luigi = ["luigi >= 3.3.0"]
memory-profiler = ["memory-profiler >= 0.61.0"]
more-itertools = ["more-itertools >= 10.1.0"]
numpy = ["numba >= 0.58.0", "numpy >= 1.25.2"]
pandas = ["pandas >= 2.1.1"]
pqdm = ["pqdm >= 0.2.0"]
psutil = ["psutil >= 5.9.5"]
pyinstrument = [
  "pyinstrument >= 4.5.3",
  "atomicwrites >= 1.4.1", # atomicwrites
]
pypi = [
  "pypiserver[passlib] >= 1.5.2",
  "loguru >= 0.7.2",                 # loguru
  "typed-settings[click] >= 23.0.0", # typed-settings
]
pytest = [
  "pytest >= 7.4.0",
  "atomicwrites >= 1.4.1", # atomicwrites
]
pytest-check = ["pytest-check >= 2.2.2"]
scipy = ["scipy >= 1.11.3"]
scripts = [
  "loguru >= 0.7.2",                 # loguru
  "typed-settings[click] >= 23.0.0", # typed-settings
]
semver = ["semver >= 3.0.0"]
sqlalchemy = [
  "sqlalchemy >= 2.0.21",
  "timeout-decorator >= 0.5.0",
  "bidict >= 0.22.1",           # bidict
  "more-itertools >= 10.1.0",   # more-itertools
]
tqdm = ["tqdm >= 4.66.1"]
typed-settings = ["typed-settings[click] >= 23.0.0"]
xarray = [
  "bottleneck >= 1.3.7",
  "xarray >= 2023.9.0",
  "numba >= 0.58.0",     # numpy
]
zarr = [
  "zarr >= 2.16.1",
  "atomicwrites >= 1.4.1", # atomicwrites
]
# groups
test = [
  "exceptiongroup >= 1.1.3",
  "pytest-cov >= 4.1.0",
  "pytest-instafail >= 0.5.0",
  "pytest-randomly >= 3.15.0",
  "pytest-rerunfailures >= 12.0",
  "pytest-xdist >= 3.3.1",
  "hypothesis >= 6.87.0",         # hypothesis
  "pytest >= 7.4.0",              # pytest
  "pytest-check >= 2.2.2",        # pytest-check
  "atomicwrites >= 1.4.1",        # pytest
]
# dev
dev = [
  # core
  "airium >= 0.2.6",                          # airium
  "atomicwrites >= 1.4.1",                    # atomicwrites
  "attrs >= 23.1.0",                          # attrs
  "beartype >= 0.16.2",                       # beartype
  "bidict >= 0.22.1",                         # bidict
  "bottleneck >= 1.3.7",                      # xarray
  "click >= 8.1.7",                           # click
  "cryptography >= 41.0.4",                   # cryptography
  "cvxpy >= 1.3.1; sys_platform == 'darwin'", # cvxpy
  "fastapi >= 0.103.0",                       # fastapi
  "fastparquet >= 2023.8.0",                  # fastparquet
  "fpdf2 >= 2.7.5",                           # fpdf2
  "hatch >= 1.7.0",                           # hatch
  "holoviews >= 1.17.1",                      # holoviews
  "hypothesis >= 6.87.0",                     # hypothesis
  "loguru >= 0.7.2",                          # loguru
  "luigi >= 3.3.0",                           # luigi
  "memory-profiler >= 0.61.0",                # memory-profiler
  "more-itertools >= 10.1.0",                 # more-itertools
  "numba >= 0.58.0",                          # xarray
  "numpy >= 1.25.2",                          # numpy
  "pandas >= 2.1.1",                          # pandas
  "pqdm >= 0.2.0",                            # pqdm
  "psutil >= 5.9.5",                          # psutil
  "pyinstrument >= 4.5.3",                    # pyinstrument
  "pypiserver[passlib] >= 1.5.2",             # pypi
  "pytest >= 7.4.0",                          # pytest
  "pytest-check >= 2.2.2",                    # pytest-check
  "scipy >= 1.11.3",                          # scipy
  "selenium >= 4.12.0",                       # holoviews
  "semver >= 3.0.0",                          # semver
  "sqlalchemy >= 2.0.21",                     # sqlalchemy
  "timeout-decorator >= 0.5.0",               # sqlalchemy
  "tqdm >= 4.66.1",                           # tqdm
  "typed-settings[click] >= 23.0.0",          # typed-settings
  "xarray >= 2023.9.0",                       # xarray
  "zarr >= 2.16.1",                           # zarr
  # test
  "exceptiongroup >= 1.1.3",      # test
  "pytest-cov >= 4.1.0",          # test
  "pytest-instafail >= 0.5.0",    # test
  "pytest-randomly >= 3.15.0",    # test
  "pytest-rerunfailures >= 12.0", # test
  "pytest-xdist >= 3.3.1",        # test
  # dev
  "coverage-conditional-plugin",
  "cx_oracle",
  "freezegun",
  "hatch",
  "hypothesis-sqlalchemy",
  "mysqlclient; sys_platform == 'darwin'",
  "nox",
  "pip-tools",
  "psycopg2-binary; sys_platform == 'darwin'",
  "pyodbc; sys_platform == 'darwin'",
]

[project.scripts]
clean-dir = "utilities.clean_dir:main"
monitor-memory = "utilities.monitor_memory:main"
start-luigi-server = "utilities.luigi.server:main"
start-pypi-server = "utilities.pypi_server:main"


#### pyright ##################################################################
[tool.pyright]
exclude = [
  "**/__pycache__",
  ".direnv",
  ".git",
  ".nox",
  "src/utilities/_numbagg",
]


#### pytest ###################################################################
[tool.pytest.ini_options]
addopts = [
  "-rsxX",
  "--color=auto",
  "--cov=utilities",
  "--cov-config=pyproject.toml",
  "--cov-report=html",
  "--strict-markers",
  "--tb=native",
]
filterwarnings = [
  "error",
  "ignore::DeprecationWarning",
  "ignore::FutureWarning",
  "ignore:Implicitly cleaning up <TemporaryDirectory '.*'>:ResourceWarning",
  "ignore:unclosed file <.*>:ResourceWarning",
]
minversion = "7.0"
testpaths = ["src/tests"]
xfail_strict = true


#### ruff #####################################################################
[tool.ruff.isort]
known-first-party = ["utilities"]

[tool.ruff.per-file-ignores]
"src/utilities/_numbagg/*.py" = ["ALL"]
